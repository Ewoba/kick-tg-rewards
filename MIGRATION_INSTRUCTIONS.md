# üîß –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–†–ò–ú–ï–ù–ï–ù–ò–Æ –ú–ò–ì–†–ê–¶–ò–ô

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏!

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è OAuthState –∏ nonceUsed

```powershell
cd drops-crypto-api

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client —Å –Ω–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏
npx prisma generate

# –°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma migrate dev --name add_oauth_state_and_nonce_used
```

**–ß—Ç–æ —Å–æ–∑–¥–∞—Å—Ç—Å—è:**
- –¢–∞–±–ª–∏—Ü–∞ `OAuthState` (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è OAuth state)
- –ü–æ–ª–µ `nonceUsed` –≤ `WalletVerification`
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `nonce`

### 2. –û–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª

–î–æ–±–∞–≤—å—Ç–µ –≤ `drops-crypto-api/.env`:

```env
# Admin allowlist (–≤–∞—à–∏ Twitch User IDs —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
ADMIN_TWITCH_IDS=123456,789012
```

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Twitch User ID:**
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT —Ç–æ–∫–µ–Ω (decoded payload) - —Ç–∞–º –µ—Å—Ç—å `twitchUserId`
3. –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: `SELECT "twitchUserId" FROM "User" LIMIT 1;`

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend

```powershell
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ backend (Ctrl+C) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞
npm run start:dev
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **OAuth State —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:3000/auth/twitch/start`
   - –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å ‚Üí –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ

2. **Admin Guard —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ `GET /admin/claims` —Å –æ–±—ã—á–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º ‚Üí 403 Forbidden ‚úÖ
   - –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π `twitchUserId` –≤ `ADMIN_TWITCH_IDS`
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ ‚Üí –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ

3. **SIWE nonce –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π:**
   - –ü–æ–ª—É—á–∏—Ç–µ nonce: `POST /me/wallet/nonce`
   - –ü–æ–¥–ø–∏—à–∏—Ç–µ –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ: `POST /me/wallet/verify`
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ nonce —Å–Ω–æ–≤–∞ ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ ‚úÖ

---

## üêõ –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Docker –∑–∞–ø—É—â–µ–Ω:

```powershell
docker ps
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: `postgres` –∏ `redis`

### –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "duplicate nonce":

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç –≤ –ë–î —É–∂–µ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã nonce. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏:

```powershell
cd drops-crypto-api
npx prisma studio
```

–ò–ª–∏ —á–µ—Ä–µ–∑ SQL:
```sql
DELETE FROM "WalletVerification";
```

–ó–∞—Ç–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é.

---

**–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑–æ–ø–∞—Å–µ–Ω!** üîí
