# ‚úÖ –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø - –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞

### 1. ‚úÖ SIWE Nonce - –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Å TTL

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ü–æ–ª–µ `nonceUsed` –≤ `WalletVerification`
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `nonce`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `nonceUsed` –ø–µ—Ä–µ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–º–µ—Ç–∫–∞ `nonceUsed = true` –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- TTL: 10 –º–∏–Ω—É—Ç (`expiresAt`)

**–§–∞–π–ª—ã:**
- `prisma/schema.prisma` - –º–æ–¥–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- `src/crypto/crypto.service.ts` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–º–µ—Ç–∫–∞ nonceUsed

### 2. ‚úÖ Admin Guard - –∑–∞—â–∏—Ç–∞ –∞–¥–º–∏–Ω API

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- `AdminGuard` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π allowlist –∏–∑ `ADMIN_TWITCH_IDS`
- –í—Å–µ –∞–¥–º–∏–Ω endpoints –∑–∞—â–∏—â–µ–Ω—ã: `@UseGuards(JwtGuard, AdminGuard)`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `twitchUserId` –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞

**–§–∞–π–ª—ã:**
- `src/auth/admin.guard.ts` - –Ω–æ–≤—ã–π guard
- `src/admin/admin.controller.ts` - –ø—Ä–∏–º–µ–Ω–µ–Ω guard

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```env
ADMIN_TWITCH_IDS=123456,789012
```

### 3. ‚úÖ OAuth State - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ú–æ–¥–µ–ª—å `OAuthState` –≤ Prisma
- State —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å TTL (10 –º–∏–Ω—É—Ç)
- State –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ callback
- State –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π)
- `AuthService` –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `AuthController`

**–§–∞–π–ª—ã:**
- `prisma/schema.prisma` - –º–æ–¥–µ–ª—å OAuthState
- `src/auth/auth.service.ts` - –º–µ—Ç–æ–¥—ã storeState/validateState
- `src/auth/auth.controller.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AuthService

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. `GET /auth/twitch/start` ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç state (64 hex), —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
2. Twitch redirect ‚Üí `GET /auth/twitch/callback?code=...&state=...`
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç state (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –Ω–µ –∏—Å—Ç–µ–∫)
4. –ü–æ–º–µ—á–∞–µ—Ç state –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
5. –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç OAuth flow

### 4. ‚úÖ SIWE –ø—Ä–∏–≤—è–∑–∫–∞ –∫ userId

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- SIWE verification –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `userId` –∏–∑ JWT (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
- Nonce —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å `userId` –∏ `address`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- Wallet –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª—ã:**
- `src/crypto/crypto.controller.ts` - —Ç—Ä–µ–±—É–µ—Ç JwtGuard
- `src/crypto/crypto.service.ts` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç userId

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

```powershell
cd drops-crypto-api

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client
npx prisma generate

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma migrate dev --name add_oauth_state_and_nonce_used
```

**–ß—Ç–æ —Å–æ–∑–¥–∞—Å—Ç—Å—è:**
- –¢–∞–±–ª–∏—Ü–∞ `OAuthState`
- –ü–æ–ª–µ `nonceUsed` –≤ `WalletVerification`
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `nonce`

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å ADMIN_TWITCH_IDS

–î–æ–±–∞–≤—å—Ç–µ –≤ `drops-crypto-api/.env`:

```env
ADMIN_TWITCH_IDS=–≤–∞—à_twitch_user_id
```

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Twitch User ID:**
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT —Ç–æ–∫–µ–Ω (decoded) ‚Üí —Ç–∞–º –µ—Å—Ç—å `twitchUserId`
3. –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î —á–µ—Ä–µ–∑ Prisma Studio: `npx prisma studio`

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend

```powershell
cd drops-crypto-api
npm run start:dev
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç 1: OAuth State –≤–∞–ª–∏–¥–∞—Ü–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ: `http://localhost:3000/auth/twitch/start`
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Twitch
3. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–æ–∫–µ–Ω–æ–º ‚úÖ

**–¢–µ—Å—Ç replay attack:**
- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL callback —Å state
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–≤–∞–∂–¥—ã
- **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Üí –æ—à–∏–±–∫–∞ "Invalid or expired OAuth state" ‚úÖ

### –¢–µ—Å—Ç 2: Admin Guard –∑–∞—â–∏—Ç–∞

1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ `GET /admin/claims` —Å –æ–±—ã—á–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
2. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: `403 Forbidden` ‚úÖ

3. –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π `twitchUserId` –≤ `ADMIN_TWITCH_IDS`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend
5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞
6. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –°–ø–∏—Å–æ–∫ claims ‚úÖ

### –¢–µ—Å—Ç 3: SIWE Nonce –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π

1. –ü–æ–ª—É—á–∏—Ç–µ nonce: `POST /me/wallet/nonce`
2. –ü–æ–¥–ø–∏—à–∏—Ç–µ –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ: `POST /me/wallet/verify`
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ nonce/signature —Å–Ω–æ–≤–∞
4. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –û—à–∏–±–∫–∞ "Nonce already used" ‚úÖ

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `SECURITY_FIXES.md` - –¥–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `MIGRATION_INSTRUCTIONS.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º
- `TESTING_CHECKLIST.md` - –ø–æ–ª–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `SETUP_GUIDE.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –∑–∞–ø—É—Å–∫—É

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Ä—É—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:

1. ‚úÖ OAuth flow —Å CSRF –∑–∞—â–∏—Ç–æ–π (state validation)
2. ‚úÖ SIWE –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ—à–µ–ª—å–∫–∞ (nonce –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π, TTL)
3. ‚úÖ Admin API –∑–∞—â–∏—â–µ–Ω (AdminGuard —Å allowlist)
4. ‚úÖ –°—Ç–∞—Ç—É—Å—ã claims —É–ø—Ä–∞–≤–ª—è–µ–º—ã —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω API
5. ‚úÖ –í—Å–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

1. ‚ö†Ô∏è –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–º. –®–∞–≥ 1)
2. ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `ADMIN_TWITCH_IDS` (—Å–º. –®–∞–≥ 2)

### ‚ùå –î–ª—è –±—É–¥—É—â–µ–≥–æ:

1. ‚ùå –†–µ–∞–ª—å–Ω–∞—è –∫—Ä–∏–ø—Ç–æ-–≤—ã–ø–ª–∞—Ç–∞ (RPC, private key, –æ—á–µ—Ä–µ–¥—å)
2. ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ (PENDING ‚Üí SUCCESS/FAILED)
3. ‚ùå Rate limiting, Swagger, —Ç–µ—Å—Ç—ã

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏** (—Å–º. MIGRATION_INSTRUCTIONS.md)
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ ADMIN_TWITCH_IDS** –≤ `.env`
3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend**
4. **–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç-–ø–ª–∞–Ω** (—Å–º. TESTING_CHECKLIST.md)

---

**–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ADMIN_TWITCH_IDS –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∏ –±–µ–∑–æ–ø–∞—Å–µ–Ω!** üîí‚úÖ
