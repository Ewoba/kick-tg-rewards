# ‚úÖ –ß–ï–ö–õ–ò–°–¢ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

## üîç –®–∞–≥ A: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å "–≤—Å—ë —Ä–∞–±–æ—á–µ–µ" —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç-–ø–ª–∞–Ω

### 1. Backend –∑–¥–æ—Ä–æ–≤—å–µ ‚úÖ
```powershell
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
http://localhost:3000/health
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: `{ "ok": true }`

### 2. –ü—É–±–ª–∏—á–Ω—ã–µ endpoints ‚úÖ
```powershell
# –°—Ç—Ä–∏–º–µ—Ä—ã
http://localhost:3000/streamers
# –û–∂–∏–¥–∞–µ—Ç—Å—è: JSON –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–∏–º–µ—Ä–æ–≤

# –ü—Ä–∏–∑—ã
http://localhost:3000/prizes
# –û–∂–∏–¥–∞–µ—Ç—Å—è: JSON –º–∞—Å—Å–∏–≤ –ø—Ä–∏–∑–æ–≤
```

### 3. –ú–æ–±–∏–ª–∫–∞ –Ω–∞ —ç–º—É–ª—è—Ç–æ—Ä–µ ‚úÖ
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –í–∫–ª–∞–¥–∫–∏ –Ω–µ –ø–∞–¥–∞—é—Ç
- ‚úÖ –°—Ç—Ä–∏–º–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- ‚úÖ –ü—Ä–∏–∑—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

### 4. –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ ‚úÖ
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Twitch
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ü—Ä–æ—Ñ–∏–ª—å"
3. –í–≤–µ–¥–∏—Ç–µ EVM –∞–¥—Ä–µ—Å: `0x1234567890123456789012345678901234567890`
4. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å"
5. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –ö–æ—à–µ–ª—ë–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚úÖ

### 5. SIWE flow (nonce ‚Üí sign ‚Üí verify ‚Üí wallet verified) ‚úÖ

**–®–∞–≥ 5.1: –ü–æ–ª—É—á–∏—Ç—å nonce**
```powershell
POST http://localhost:3000/me/wallet/nonce
Authorization: Bearer <token>
Content-Type: application/json

{
  "address": "0x1234567890123456789012345678901234567890"
}
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: `{ "success": true, "nonce": "...", "message": "..." }`

**–®–∞–≥ 5.2: –ü–æ–¥–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MetaMask –∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–æ—à–µ–ª—ë–∫
- –ü–æ–¥–ø–∏—à–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ `message` (SIWE)
- –ü–æ–ª—É—á–∏—Ç–µ `signature`

**–®–∞–≥ 5.3: –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å**
```powershell
POST http://localhost:3000/me/wallet/verify
Authorization: Bearer <token>
Content-Type: application/json

{
  "message": "...",
  "signature": "..."
}
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: `{ "success": true, "verified": true, "address": "..." }`

**–®–∞–≥ 5.4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å**
```powershell
GET http://localhost:3000/me/wallet/status
Authorization: Bearer <token>
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: `{ "verified": true, "address": "..." }`

**–¢–µ—Å—Ç 5.5: Nonce –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π (replay attack)**
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ nonce –∏ signature —Å–Ω–æ–≤–∞
- **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –û—à–∏–±–∫–∞ `"Nonce already used"` ‚úÖ

### 6. Claim —Å–æ–∑–¥–∞—ë—Ç—Å—è, –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ "–º–æ–∏—Ö –ø—Ä–∏–∑–∞—Ö" ‚úÖ

**–®–∞–≥ 6.1: –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ü—Ä–∏–∑—ã"
2. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å" –Ω–∞ –ª—é–±–æ–º –ø—Ä–∏–∑–µ
3. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ claim ‚úÖ

**–®–∞–≥ 6.2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ "–ú–æ–∏ –ø—Ä–∏–∑—ã"**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ú–æ–∏ –ø—Ä–∏–∑—ã"
2. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: Claim –≤–∏–¥–µ–Ω —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–û–∂–∏–¥–∞–µ—Ç" (PENDING) ‚úÖ

### 7. –ê–¥–º–∏–Ω –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å claim ‚Üí –º–æ–±–∏–ª–∫–∞ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚úÖ

**–®–∞–≥ 7.1: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ claims (–∫–∞–∫ –∞–¥–º–∏–Ω)**
```powershell
GET http://localhost:3000/admin/claims
Authorization: Bearer <admin_token>
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö claims ‚úÖ

**–®–∞–≥ 7.2: –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å**
```powershell
PUT http://localhost:3000/admin/claims/{claimId}/mark-success
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "txHash": "0x1234567890abcdef..."
}
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: `{ "success": true, "claim": { "status": "SUCCESS", ... } }`

**–®–∞–≥ 7.3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –º–æ–±–∏–ª–∫–µ**
1. –û–±–Ω–æ–≤–∏—Ç–µ —ç–∫—Ä–∞–Ω "–ú–æ–∏ –ø—Ä–∏–∑—ã" (pull-to-refresh)
2. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ "–£—Å–ø–µ—à–Ω–æ" ‚úÖ

**–¢–µ—Å—Ç 7.4: Admin Guard –∑–∞—â–∏—Ç–∞**
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ `PUT /admin/claims/{id}/mark-success` —Å –æ–±—ã—á–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
- **–û–∂–∏–¥–∞–µ—Ç—Å—è**: `403 Forbidden` ‚úÖ

---

## üîê –®–∞–≥ B: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∞–¥–º–∏–Ω–∫–∏ (MVP-safe)

### 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å ADMIN_TWITCH_IDS ‚úÖ

**–§–∞–π–ª**: `drops-crypto-api/.env`

```env
ADMIN_TWITCH_IDS=123456,789012
```

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Twitch User ID:**
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT —Ç–æ–∫–µ–Ω (decoded) ‚Üí —Ç–∞–º –µ—Å—Ç—å `twitchUserId`
3. –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î:
   ```sql
   SELECT "twitchUserId" FROM "User" LIMIT 1;
   ```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å AdminGuard ‚úÖ

**–¢–µ—Å—Ç 1: –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí 403**
```powershell
$token = "regular_user_token"
$headers = @{ Authorization = "Bearer $token" }
Invoke-RestMethod -Uri http://localhost:3000/admin/claims -Headers $headers
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: `403 Forbidden` ‚úÖ

**–¢–µ—Å—Ç 2: –ê–¥–º–∏–Ω ‚Üí 200**
```powershell
$token = "admin_user_token"  # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ ADMIN_TWITCH_IDS
$headers = @{ Authorization = "Bearer $token" }
Invoke-RestMethod -Uri http://localhost:3000/admin/claims -Headers $headers
```
**–û–∂–∏–¥–∞–µ—Ç—Å—è**: –°–ø–∏—Å–æ–∫ claims ‚úÖ

---

## üîí –®–∞–≥ C: OAuth State –ø—Ä–æ–≤–µ—Ä–∫–∞ (CSRF –∑–∞—â–∏—Ç–∞)

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é ‚úÖ

```powershell
cd drops-crypto-api
npx prisma generate
npx prisma migrate dev --name add_oauth_state_and_nonce_used
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å OAuth flow ‚úÖ

**–¢–µ—Å—Ç 1: –ù–æ—Ä–º–∞–ª—å–Ω—ã–π flow**
1. –û—Ç–∫—Ä–æ–π—Ç–µ: `http://localhost:3000/auth/twitch/start`
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Twitch
3. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–æ–∫–µ–Ω–æ–º ‚úÖ

**–¢–µ—Å—Ç 2: State –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π**
1. –û—Ç–∫—Ä–æ–π—Ç–µ: `http://localhost:3000/auth/twitch/start`
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL —Å state
3. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ state –µ—â–µ —Ä–∞–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∫—Ä—ã—Ç—å callback URL –≤—Ä—É—á–Ω—É—é)
5. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –û—à–∏–±–∫–∞ `"Invalid or expired OAuth state"` ‚úÖ

**–¢–µ—Å—Ç 3: State —Å –∏—Å—Ç–µ–∫—à–∏–º TTL**
- State —Ö—Ä–∞–Ω–∏—Ç—Å—è 10 –º–∏–Ω—É—Ç
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ ‚úÖ

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –í—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

1. ‚úÖ `/health`, `/streamers`, `/prizes` —Ä–∞–±–æ—Ç–∞—é—Ç
2. ‚úÖ –ú–æ–±–∏–ª–∫–∞ –≥—Ä—É–∑–∏—Ç –¥–∞–Ω–Ω—ã–µ
3. ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. ‚úÖ SIWE flow —Ä–∞–±–æ—Ç–∞–µ—Ç (nonce ‚Üí verify)
5. ‚úÖ Nonce –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π (replay –∑–∞—â–∏—Ç–∞)
6. ‚úÖ Claim —Å–æ–∑–¥–∞—ë—Ç—Å—è, –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ "–º–æ–∏—Ö –ø—Ä–∏–∑–∞—Ö"
7. ‚úÖ –ê–¥–º–∏–Ω –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å ‚Üí –º–æ–±–∏–ª–∫–∞ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ
8. ‚úÖ Admin Guard –∑–∞—â–∏—â–∞–µ—Ç endpoints (403 –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
9. ‚úÖ OAuth state —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end (CSRF –∑–∞—â–∏—Ç–∞)

---

## üêõ –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "Property 'oAuthState' does not exist"

**–†–µ—à–µ–Ω–∏–µ:**
```powershell
cd drops-crypto-api
npx prisma generate
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Nonce already used" –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞, –∏ –ø–æ–ª–µ `nonceUsed` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

### –ü—Ä–æ–±–ª–µ–º–∞: "403 Forbidden" –¥–ª—è –∞–¥–º–∏–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. `ADMIN_TWITCH_IDS` –∑–∞–ø–æ–ª–Ω–µ–Ω –≤ `.env`
2. `twitchUserId` –≤ JWT —Ç–æ–∫–µ–Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å allowlist
3. Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env`

### –ü—Ä–æ–±–ª–µ–º–∞: "Invalid or expired OAuth state"

**–†–µ—à–µ–Ω–∏–µ:** 
- State –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
- State –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π (–ø–æ–º–µ—á–∞–µ—Ç—Å—è used)
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤—ã–π OAuth flow

---

**–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** ‚úÖ
