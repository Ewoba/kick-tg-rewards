# üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. ‚úÖ SIWE Nonce - –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å –∏ TTL

**–ü—Ä–æ–±–ª–µ–º–∞**: Nonce –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ (replay attack)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `nonceUsed` –≤ `WalletVerification`
- –î–æ–±–∞–≤–ª–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `nonce`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `nonceUsed` –ø–µ—Ä–µ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–º–µ—Ç–∫–∞ `nonceUsed = true` –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª—ã**:
- `prisma/schema.prisma` - –º–æ–¥–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- `src/crypto/crypto.service.ts` - –ø—Ä–æ–≤–µ—Ä–∫–∞ nonceUsed

### 2. ‚úÖ Admin Guard - –∑–∞—â–∏—Ç–∞ –∞–¥–º–∏–Ω API

**–ü—Ä–æ–±–ª–µ–º–∞**: –õ—é–±–æ–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã claims

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
- –°–æ–∑–¥–∞–Ω `AdminGuard` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π allowlist
- Allowlist –∏–∑ `ADMIN_TWITCH_IDS` –≤ `.env`
- –í—Å–µ –∞–¥–º–∏–Ω endpoints –∑–∞—â–∏—â–µ–Ω—ã: `@UseGuards(JwtGuard, AdminGuard)`

**–§–∞–π–ª—ã**:
- `src/auth/admin.guard.ts` - –Ω–æ–≤—ã–π guard
- `src/admin/admin.controller.ts` - –ø—Ä–∏–º–µ–Ω–µ–Ω guard

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞**:
```env
ADMIN_TWITCH_IDS=123456,789012
```

### 3. ‚úÖ OAuth State - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**: State –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è (CSRF —É—è–∑–≤–∏–º–æ—Å—Ç—å)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `OAuthState` –≤ Prisma
- State —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å TTL (10 –º–∏–Ω—É—Ç)
- State –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ callback
- State –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
- `AuthService` –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `AuthController`

**–§–∞–π–ª—ã**:
- `prisma/schema.prisma` - –º–æ–¥–µ–ª—å OAuthState
- `src/auth/auth.service.ts` - –º–µ—Ç–æ–¥—ã storeState/validateState
- `src/auth/auth.controller.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AuthService

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
1. `GET /auth/twitch/start` ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç state, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
2. Twitch redirect ‚Üí `GET /auth/twitch/callback?code=...&state=...`
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç state (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –Ω–µ –∏—Å—Ç–µ–∫)
4. –ü–æ–º–µ—á–∞–µ—Ç state –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
5. –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç OAuth flow

### 4. ‚úÖ Prisma Seed - –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: Seed –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `upsert`, –∑–Ω–∞—á–∏—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π ‚úÖ

**–§–∞–π–ª**: `prisma/seed.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `upsert` –≤–µ–∑–¥–µ

### 5. ‚úÖ utils/api.ts - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: API_BASE = `http://10.0.2.2:3000` –¥–ª—è —ç–º—É–ª—è—Ç–æ—Ä–∞ ‚úÖ

**–§–∞–π–ª**: `drops-crypto-app/utils/api.ts` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 401

---

## üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. –û–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª

–î–æ–±–∞–≤—å—Ç–µ –≤ `drops-crypto-api/.env`:

```env
# Admin allowlist (–≤–∞—à–∏ Twitch User IDs —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
ADMIN_TWITCH_IDS=123456,789012
```

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Twitch User ID:**
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω (JWT payload) –∏–ª–∏ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ User)
3. –î–æ–±–∞–≤—å—Ç–µ `twitchUserId` –≤ allowlist

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```powershell
cd drops-crypto-api
npx prisma migrate dev
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç:
- –¢–∞–±–ª–∏—Ü—É `OAuthState`
- –ü–æ–ª–µ `nonceUsed` –≤ `WalletVerification`
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `nonce`

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –¢–µ—Å—Ç 1: OAuth State –≤–∞–ª–∏–¥–∞—Ü–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ: `http://localhost:3000/auth/twitch/start`
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Twitch
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: callback –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ state –¥–≤–∞–∂–¥—ã ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ ‚úÖ

### –¢–µ—Å—Ç 2: Admin Guard

1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å claim —Å –æ–±—ã—á–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º ‚Üí 403 Forbidden ‚úÖ
2. –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π `twitchUserId` –≤ `ADMIN_TWITCH_IDS`
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ ‚Üí –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ

### –¢–µ—Å—Ç 3: SIWE Nonce –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—Å—Ç—å

1. –ü–æ–ª—É—á–∏—Ç–µ nonce: `POST /me/wallet/nonce`
2. –ü–æ–¥–ø–∏—à–∏—Ç–µ –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ: `POST /me/wallet/verify`
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ nonce —Å–Ω–æ–≤–∞ ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ ‚úÖ

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- ‚úÖ OAuth state –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- ‚úÖ OAuth state –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ callback
- ‚úÖ OAuth state –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π (–ø–æ–º–µ—á–∞–µ—Ç—Å—è used)
- ‚úÖ OAuth state –∏–º–µ–µ—Ç TTL (10 –º–∏–Ω—É—Ç)
- ‚úÖ Admin endpoints –∑–∞—â–∏—â–µ–Ω—ã allowlist
- ‚úÖ SIWE nonce –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π (nonceUsed)
- ‚úÖ SIWE nonce –∏–º–µ–µ—Ç TTL (10 –º–∏–Ω—É—Ç)
- ‚úÖ SIWE –ø—Ä–∏–≤—è–∑–∫–∞ –∫ userId —á–µ—Ä–µ–∑ JWT

---

## üö® –í–∞–∂–Ω–æ

**–î–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ —É–±–µ–¥–∏—Ç–µ—Å—å:**
1. ‚úÖ `ADMIN_TWITCH_IDS` –∑–∞–ø–æ–ª–Ω–µ–Ω –≤ `.env`
2. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
3. ‚úÖ OAuth state —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end
4. ‚úÖ Admin Guard –ø—Ä–æ–≤–µ—Ä–µ–Ω

---

**–¢–µ–ø–µ—Ä—å –ø—Ä–æ–µ–∫—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!** üîí
