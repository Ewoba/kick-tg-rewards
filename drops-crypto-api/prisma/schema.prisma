datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ENUMS
// ============================================

enum ClaimStatus {
  PENDING     // Created, awaiting processing
  PROCESSING  // Transaction sent, awaiting confirmation
  SUCCESS     // Transaction confirmed
  FAILED      // Transaction failed
}

// ============================================
// MODELS
// ============================================

model User {
  id           String       @id @default(uuid())
  twitchUserId String       @unique
  twitchLogin  String
  createdAt    DateTime     @default(now())
  wallet       Wallet?
  prizeClaims  PrizeClaim[]
  follows      UserFollow[]
}

model Wallet {
  id         String   @id @default(uuid())
  userId     String   @unique
  chain      String   // "base"
  address    String
  verified   Boolean  @default(false)  // SIWE verified
  createdAt  DateTime @default(now())
  verifiedAt DateTime?
  user       User     @relation(fields: [userId], references: [id])
}

model WalletVerification {
  id        String   @id @default(uuid())
  userId    String
  address   String
  nonce     String   // Random string for signing
  message   String?  // Full SIWE message
  verified  Boolean  @default(false)
  nonceUsed Boolean  @default(false) // Prevent replay attacks
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@unique([userId, address])
  @@unique([nonce]) // Ensure nonce uniqueness
  @@index([nonce])
}

model OAuthState {
  id        String   @id @default(uuid())
  state     String   @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([state])
  @@index([used, expiresAt])
}

model Streamer {
  id          String       @id @default(uuid())
  twitchId    String       @unique
  twitchLogin String
  displayName String
  avatarUrl   String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  prizes      Prize[]
  followers   UserFollow[]
}

model UserFollow {
  id         String   @id @default(uuid())
  userId     String
  streamerId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  streamer   Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)

  @@unique([userId, streamerId])
  @@index([userId])
  @@index([streamerId])
}

model Prize {
  id          String       @id @default(uuid())
  streamerId  String
  title       String
  description String?
  imageUrl    String?
  tokenAmount String?      // Amount in tokens/coins (e.g., "10.5")
  tokenSymbol String?      // Token symbol (e.g., "USDC")
  chain       String       @default("base")
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  streamer    Streamer     @relation(fields: [streamerId], references: [id])
  claims      PrizeClaim[]
}

model PrizeClaim {
  id           String      @id @default(uuid())
  userId       String
  prizeId      String
  status       ClaimStatus @default(PENDING)
  claimedAt    DateTime    @default(now())
  processedAt  DateTime?   // When processing started
  completedAt  DateTime?   // When completed (success or fail)
  txHash       String?     // Transaction hash on-chain
  txError      String?     // Error message if failed
  retryCount   Int         @default(0)
  user         User        @relation(fields: [userId], references: [id])
  prize        Prize       @relation(fields: [prizeId], references: [id])

  @@unique([userId, prizeId])
  @@index([status])
  @@index([userId])
}
